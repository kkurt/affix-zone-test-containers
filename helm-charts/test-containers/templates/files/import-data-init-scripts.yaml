apiVersion: v1
kind: ConfigMap
metadata:
  name: import-data-init-scripts
data:
  postgres-init-test-db.sql: |
    CREATE DATABASE test;
    CREATE USER test WITH ENCRYPTED PASSWORD 'test';
    GRANT ALL PRIVILEGES ON DATABASE test TO test;

    \q
  postgres-create-test-tables.sql: |
    \c test
{{ if .Values.db.postgresql.init.testdb.import.namebasics }}
    CREATE TABLE IF NOT EXISTS name_basics (
                                               nconst TEXT PRIMARY KEY,
                                               primaryName TEXT,
                                               birthYear TEXT,
                                               deathYear TEXT,
                                               primaryProfession TEXT,
                                               knownForTitles TEXT
    );
    \copy name_basics FROM '/tmp/name.basics.tsv' WITH (FORMAT csv, DELIMITER E'\t', HEADER true, NULL '\N');
{{ end }}
{{ if .Values.db.postgresql.init.testdb.import.titleratings }}
    CREATE TABLE IF NOT EXISTS title_ratings (
                                                 tconst TEXT PRIMARY KEY,
                                                 averageRating NUMERIC,
                                                 numVotes INT
    );
    \copy title_ratings FROM '/tmp/title.ratings.tsv' WITH (FORMAT csv, DELIMITER E'\t', HEADER true, NULL '\N');
    \q
{{ end }}
